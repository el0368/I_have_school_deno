# Sovereign Academy — Project Structure Lessons

This file explains every folder in the project so any new team member (or
future-you) can understand what lives where and why.

---

## Root-level folders at a glance

```
Ihaveschool_deno/
├── .github/          ← automation & Copilot rules
├── .vscode/          ← editor settings
├── _fresh/           ← build output (auto-generated, do not edit)
├── desktop/          ← native Windows app shell (Rust, FROZEN CORE)
├── docs/             ← guides, plans, notes, and this file
├── islands/          ← interactive UI components (Preact)
├── lib/              ← shared business logic (TypeScript)
├── math-engine/      ← math answer checker (Rust → WASM)
├── native/           ← Deno FFI bridge to the native system (Rust)
├── node_modules/     ← JavaScript dependencies (auto-managed, do not edit)
├── routes/           ← web pages and API endpoints (Fresh)
├── scripts/          ← developer tools and CI helpers
├── static/           ← files served directly to the browser
├── subjects/         ← curriculum content (problems, topics, grades)
└── tests/            ← automated tests
```

---

## `.github/`

Contains GitHub-specific files.

| File                      | Purpose                                                                                                                                      |
| ------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| `copilot-instructions.md` | Rules that GitHub Copilot follows when helping in this repo. Defines architecture, code style, frozen-core rules, and anti-drift principles. |
| `workflows/verify.yml`    | GitHub Actions CI pipeline. Runs automatically on every push/PR: Rust tests → Vitest unit tests → snapshot checks.                           |

**Lesson:** The CI pipeline is your safety net. If it goes red, do not merge.

---

## `_fresh/`

Auto-generated by `deno task build`. Contains compiled JavaScript ready to send
to the browser — server entry, client bundles, and the compiled CSS.

**Never edit files here.** They are overwritten every build. Make your changes
in `islands/`, `routes/`, or `static/` instead.

---

## `desktop/`

The native Windows application shell. Written in Rust using:

- **tao** — creates and manages the OS window
- **wry** — embeds a web view (Chromium) inside that window
- **Win32 FFI** — custom code for a frameless, draggable, resizable window

```
desktop/
├── Cargo.toml   ← Rust project manifest
├── README.md    ← desktop-specific notes
└── src/
    └── main.rs  ← ⚠️ FROZEN CORE — do not modify without approval
```

**Lesson:** `main.rs` handles window creation, the title-bar drag region,
8-direction native resize, and the IPC bridge between JavaScript and Rust.
It has been audited to zero warnings and must stay that way. Treat it like
load-bearing infrastructure — ask before touching.

---

## `docs/`

Human-readable documentation about the project's strategy, architecture,
and process.

| File                              | Purpose                                                                |
| --------------------------------- | ---------------------------------------------------------------------- |
| `TAGGING_STRATEGY.md`             | When and how to create git tags (e.g. `v0.6.0`).                       |
| `GIT_BISECT_GUIDE.md`             | How to use `git bisect` to find the exact commit that broke something. |
| `anti_logic_drift_principles.txt` | The philosophy behind keeping math/physics logic pure and testable.    |
| `deno-webui-plan.txt`             | Early architectural planning notes.                                    |
| `TUTORIAL.md`                     | Step-by-step walkthrough for new developers.                           |
| `file.todo`                       | Backup copy of the main implementation tracking file.                  |
| `PROJECT_STRUCTURE_LESSONS.md`    | This file.                                                             |

**Lesson:** When you are lost, start here. These files capture decisions and
the reasoning behind them.

---

## `islands/`

Preact "islands" — the interactive parts of the UI. Each file is a component
that hydrates in the browser.

| File            | Purpose                                                                                                         |
| --------------- | --------------------------------------------------------------------------------------------------------------- |
| `MathStage.tsx` | The main exercise area. Shows a question, accepts an answer, gives feedback, and advances to the next question. |
| `Sidebar.tsx`   | The left panel showing topic list and user navigation (like Discord's channel list).                            |
| `TitleBar.tsx`  | The custom window title bar with minimize/maximize/close buttons for the native shell.                          |

**Lesson:** Islands are the _view layer only_ — they display data and fire
events. All math logic, state management, and data loading live in `lib/`.

---

## `lib/`

The brain of the application. Pure TypeScript modules with no UI code.

| File                   | Purpose                                                                                                                     |
| ---------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| `types.ts`             | Shared TypeScript interfaces (e.g. `MathWasm`, `Exercise`, `Topic`). Single source of truth for data shapes.                |
| `state.ts`             | Global Preact signals (`activeTopic`, `exerciseIndex`, etc.). All app-wide state lives here.                                |
| `validation.ts`        | Checks whether a student's answer is correct. Uses the WASM engine first, falls back to plain JS if WASM is unavailable.    |
| `wasm-loader.ts`       | Initialises the WASM binary on startup and exposes the loaded module.                                                       |
| `wasm-health-check.ts` | Runs a battery of test calls against the WASM module to confirm it works correctly.                                         |
| `exercise-loader.ts`   | Reads exercise `.bin` files from `static/` and parses them into `Exercise` objects. Falls back to generated demo exercises. |
| `msgpack-loader.ts`    | Helper for future MessagePack-encoded exercise files.                                                                       |
| `native.ts`            | Deno FFI bindings — calls into the native Rust `native/` library for system features.                                       |
| `schemas.ts`           | Zod (or similar) schemas for validating exercise file structure.                                                            |
| `*.test.ts`            | Unit tests for the matching module (run with `deno task test:unit`).                                                        |

**Lesson:** If you need to add a new feature, ask yourself: "Is this logic or
display?" Logic belongs in `lib/`, display belongs in `islands/`.

---

## `math-engine/`

A Rust library compiled to **WebAssembly**. This is what actually checks
whether a math answer is correct.

```
math-engine/
├── Cargo.toml
├── src/
│   └── lib.rs        ← WASM exports: check_answer(), etc.
└── tests/
    └── purity_test.rs ← 22 determinism/purity tests
```

**Why Rust?** Math validation must be fast, exact, and impossible to cheat.
Rust gives us type safety, zero runtime errors, and the same binary runs in
the browser (WASM) and in tests.

**Lesson:** All functions here must be **pure** — same input always produces
the same output, with no network calls, no randomness, no side effects. This
is enforced by the purity tests.

---

## `native/`

A Rust library that Deno loads via **FFI** (Foreign Function Interface).
Provides system-level features that JavaScript alone cannot do — such as
reading hardware info or controlling the native window from TypeScript.

```
native/
├── Cargo.toml
└── src/
    └── lib.rs    ← functions exposed to Deno over FFI
```

**Lesson:** `lib/native.ts` is the TypeScript side of this bridge. The Rust
side lives here. If a feature needs to talk to the operating system, this
is where it goes.

---

## `routes/`

Fresh framework pages and API handlers. Each file maps directly to a URL.

```
routes/
├── index.tsx          → GET /          (main app page)
├── _app.tsx           → layout wrapper (applied to every page)
├── _404.tsx           → 404 not found page
└── api/
    ├── manifest.ts    → GET /api/manifest  (exercise manifest)
    └── window/        → POST /api/window/* (IPC for native window controls)
```

**Lesson:** Routes are thin wrappers. They import islands and pass server-side
data as props. Business logic does not belong here.

---

## `scripts/`

Developer utility scripts. Run manually or by CI, never loaded by the app.

| File                  | Purpose                                                                                                 |
| --------------------- | ------------------------------------------------------------------------------------------------------- |
| `bisect-verify.ts`    | Used by `git bisect run` — exits 0 (good), 1 (bad), or 125 (skip). Runs the full verification pipeline. |
| `snapshot-ui.ts`      | Renders each island to HTML and saves the output as golden snapshots.                                   |
| `snapshot-state.ts`   | Captures the state machine transitions as a log (golden snapshot).                                      |
| `snapshot-physics.ts` | Captures physics calculation outputs as a golden snapshot.                                              |
| `verify-snapshots.ts` | Compares current output against the saved golden snapshots. Fails if anything drifted.                  |

**Lesson:** Golden snapshots are your regression detector. If a snapshot
changes unexpectedly, something in the logic changed — intentional or not.

---

## `static/`

Files served as-is to the browser. No build step involved.

```
static/
├── discord.css   ← the entire Discord-style theme (dark mode, variables, all components)
├── favicon.ico   ← browser tab icon
├── logo.svg      ← app logo
└── wasm/
    ├── math_validator.js        ← JS glue code (auto-generated from Rust)
    ├── math_validator_bg.wasm   ← the compiled WASM binary
    └── *.d.ts                   ← TypeScript type declarations for WASM
```

**Lesson:** `discord.css` is the single source of truth for all visual styles.
Never use inline `style="..."` in components — use class names from this file.

---

## `subjects/`

The curriculum content — questions organised by subject, grade, and topic.

```
subjects/
├── math/
│   ├── by grade/     ← problems sorted by school grade level
│   └── by_topics/    ← problems sorted by mathematical topic
└── physics/
    ├── middle_school_physics.txt
    ├── high_school_physics.txt
    ├── ap_physics_1.txt
    ├── ap_physics_2.txt
    └── LEARNING_ORDER.txt   ← recommended teaching sequence
```

**Lesson:** This is raw curriculum data — not yet compiled into the `.bin`
exercise format the app reads. Phase 7 will add the tool that converts these
text files into binary exercise packs.

---

## `tests/`

Automated tests that are not co-located with source files.

```
tests/
├── e2e/
│   ├── navigation.spec.ts        ← Playwright: can the user navigate topics?
│   └── math-validation.spec.ts   ← Playwright: does answer checking work end-to-end?
└── golden/
    ├── ui-mathstage.html   ← expected HTML output of MathStage island
    ├── ui-sidebar.html     ← expected HTML output of Sidebar island
    ├── ui-titlebar.html    ← expected HTML output of TitleBar island
    ├── ui-theme.html       ← expected HTML output of theme/layout
    ├── physics.txt         ← expected physics calculation outputs
    └── state-flow.log      ← expected state machine transition sequence
```

**Lesson:**

- `e2e/` tests simulate a real user clicking through the app in a real browser.
- `golden/` snapshots detect invisible regressions — when the output changes
  in a way no one noticed, the snapshot diff catches it.

---

## Summary: Where does new code go?

| What you are building            | Where it goes                          |
| -------------------------------- | -------------------------------------- |
| A new UI component               | `islands/`                             |
| A new page or URL                | `routes/`                              |
| Business logic / data processing | `lib/`                                 |
| Math answer checking             | `math-engine/src/lib.rs`               |
| System / OS feature              | `native/src/lib.rs` + `lib/native.ts`  |
| A CSS style                      | `static/discord.css`                   |
| A developer utility script       | `scripts/`                             |
| A unit test                      | Next to the source file as `*.test.ts` |
| An end-to-end test               | `tests/e2e/`                           |
| Curriculum questions             | `subjects/`                            |
| Documentation                    | `docs/`                                |
