================================================================================
  SOVEREIGN ACADEMY â€” HOW THE PROJECT WORKS
  A Comprehensive Guide for Developers and AI Agents
================================================================================

  Version:  February 2026
  Stack:    Deno + Fresh 2.2.0 + Preact + Rust WASM + Rust Desktop Shell


================================================================================
  SECTION 1: THE BIG PICTURE
================================================================================

  Sovereign Academy is a math learning application built in a very unusual way.
  It has THREE layers, each written in a different technology:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚         LAYER 1: NATIVE SHELL (Rust)                           â”‚
  â”‚   desktop/src/main.rs  â†’  sovereign.exe                        â”‚
  â”‚   Draws the frameless window. Thinks it's a web browser.       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚  Opens a WebView pointing to:
                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚         LAYER 2: WEB APPLICATION (Deno + Fresh)                â”‚
  â”‚   main.ts â†’ routes/ â†’ islands/ â†’ lib/                          â”‚
  â”‚   Serves the UI. Handles logic. Handles navigation.            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚  Loads and calls:
                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚         LAYER 3: MATH ENGINE (Rust compiled to WASM)           â”‚
  â”‚   math-engine/src/lib.rs â†’ static/wasm/math_validator.wasm     â”‚
  â”‚   Validates student answers. Pure math. No UI.                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  The three layers are INDEPENDENT. You can develop each one separately.
  In browser mode, you only need Layer 2 + Layer 3.
  In full desktop mode, all three layers run together.


================================================================================
  SECTION 2: THE NATIVE SHELL (Rust Desktop â€” desktop/)
================================================================================

  FILE: desktop/src/main.rs
  STATUS: FROZEN CORE â€” Do NOT modify without a formal review plan.

  What it does:
    - Creates a native, FRAMELESS window (no OS title bar).
    - Uses the "tao" crate for cross-platform window management.
    - Uses the "wry" crate to embed a WebView (like a mini Chrome) inside.
    - The WebView loads http://localhost:5173 (the Deno app).
    - Handles native OS events (resize, drag, close).

  Key Win32 techniques used (Windows):
    - WM_NCHITTEST: Tells Windows which area of the window to drag/resize.
    - DwmExtendFrameIntoClientArea: Removes the OS title bar chrome.
    - WM_NCCALCSIZE: Removes the standard window border.
    - 8-direction resize handles injected via JavaScript.

  IPC Bridge:
    The WebView can send messages to the Rust shell via a JavaScript API.
    The shell responds by performing native window operations.

  How to run:
    deno task launch:desktop   â† Starts BOTH the Deno server and the Rust shell
    deno task build:desktop    â† Compiles to desktop/target/release/sovereign.exe


================================================================================
  SECTION 3: THE WEB APPLICATION (Deno + Fresh 2.2.0)
================================================================================

  This is the heart of the application. It runs as a web server using Deno
  and the Fresh framework. The UI is built with Preact (a tiny React clone).

  â”€â”€ 3.1 STARTUP FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    1. main.ts starts the Deno HTTP server (`deno serve`).
    2. Fresh reads fresh.gen.ts to know all routes and islands.
    3. Browser requests http://localhost:5173 (or :8000 in production).
    4. Fresh renders routes/_app.tsx as the HTML shell:
         - Adds <link> to static/discord.css (the theme).
         - Adds the <body class="discord-app"> class.
    5. Fresh renders routes/index.tsx as the page layout (see below).
    6. Vite (inside Fresh) handles hot module reloading in dev mode.

  â”€â”€ 3.2 THE PAGE LAYOUT (routes/index.tsx) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    The main page is assembled like a Discord window:

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  TitleBar.tsx (custom drag + min/max/close buttons)          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚          â”‚                                   â”‚               â”‚
    â”‚ Sidebar  â”‚      MathStage.tsx                â”‚  LessonToc    â”‚
    â”‚ .tsx     â”‚  (main learning area)             â”‚  .tsx         â”‚
    â”‚          â”‚                                   â”‚  (right TOC)  â”‚
    â”‚  Topic   â”‚  Exercise Card / Lesson View /    â”‚               â”‚
    â”‚  List    â”‚  Simulator                        â”‚  Links to     â”‚
    â”‚          â”‚                                   â”‚  sections     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”€â”€ 3.3 ISLANDS (islands/) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    In Fresh, "Islands" are the interactive parts of the page.
    Everything NOT in an island is server-rendered HTML (static and fast).
    Islands are hydrated in the browser (they become interactive).

    islands/TitleBar.tsx:
      - Shows the app name and window controls (minimize/maximize/close).
      - Buttons POST to /api/window/[action] which calls the Rust IPC bridge.
      - Uses useSignalEffect to add/remove the "maximized" CSS class on <body>,
        which adds 8px padding to compensate for OS-level window expansion.
      - The title bar is position:sticky so it is ALWAYS visible.

    islands/Sidebar.tsx:
      - Shows the 19 math topics as Discord-style "channels".
      - Reads the TOPICS list from lib/state.ts.
      - When a topic is clicked, calls selectTopic(id) to update global state.
      - Shows a progress bar at the top and per-topic completion badges.

    islands/MathStage.tsx:
      - The main learning area. Shows either:
          a) An exercise card (a math problem to solve).
          b) Lesson view (markdown text explaining a concept).
          c) Volume Simulator (an interactive 3D shape simulator).
      - Loads WASM on startup and runs a health check (3 validation tests).
      - Loads exercises from the binary file server via lib/exercise-loader.ts.
      - On answer submit, calls the WASM engine to validate the answer.
      - On correct answer, auto-advances after 1.5 seconds.

    islands/LessonToc.tsx:
      - Right sidebar showing a table of contents for the current lesson.
      - When a TOC link is clicked, smoothly scrolls the .stage-content div
        to that section (using manual offsetTop calculation â€” NOT scrollIntoView,
        because scrollIntoView could scroll the entire page and hide the TitleBar).
      - Also shows "Related Topics" links.

    islands/VolumeSimulator.tsx:
      - A fully interactive 3D geometry simulator.
      - Renders isometric 3D shapes (Cube, Rectangular Prism, Pyramid) as SVGs.
      - Users can adjust sliders (length, width, height) in real time.
      - Calculates and displays volume and surface area formulas live.
      - Has a "net view" that shows the unfolded shape.

  â”€â”€ 3.4 ROUTES (routes/) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    routes/_app.tsx:
      Wraps every page with the HTML skeleton:
      <html>, <head>, <link rel="stylesheet">, <body class="discord-app">.

    routes/index.tsx:
      The main "/" page. Assembles TitleBar + Sidebar + MathStage + LessonToc.

    routes/lesson/[...slug].tsx:
      Serves MDX lesson content. The [slug] matches any file path under content/.
      Example: /lesson/lesson-demo â†’ content/lesson-demo.mdx

    routes/api/window/[action].ts:
      REST API called by TitleBar buttons. Forwards to native Rust shell via IPC.
      Actions: minimize, maximize, close, resize.

    routes/api/manifest.ts:
      Returns JSON of all 19 topics and their 1,814 exercise file paths.

    routes/_middleware.ts:
      Intercepts requests to /exercises/*.bin and streams the binary files
      efficiently (zero-copy). Sets proper caching headers.

  â”€â”€ 3.5 LIB (lib/) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    These are pure TypeScript utility files. They have no UI code.
    They are tested directly with Vitest.

    lib/state.ts:
      The global application state. Uses Preact Signals (NOT useState).
      Signals are reactive â€” when a signal changes, any island that reads it
      automatically re-renders. Zero boilerplate.

      Key signals:
        activeTopic     â†’ Which topic (1-19) is selected.
        activeTopicData â†’ The Topic object for the selected topic (computed).
        currentExercise â†’ The exercise being shown.
        studentAnswer   â†’ What the student typed.
        lastResult      â†’ The result from the last WASM validation.
        progress        â†’ Map(topicId â†’ exercisesCompleted).
        totalCompleted  â†’ Sum of all progress (computed).
        isMaximized     â†’ Whether the window is maximized.

      Key actions:
        selectTopic(id)      â†’ Change topic and reset exercise state.
        markCompleted(id)    â†’ Increment progress counter for that topic.

    lib/exercise-loader.ts:
      Fetches exercise binary files (.bin) from the server.
      Parses the binary format:
        Byte 0: Type (1=arithmetic, 2=fraction, 3=equation)
        Bytes 1-2: Problem string length (uint16)
        Bytes 3+: Problem string (UTF-8)
        ...same pattern for answer string
      Uses an in-memory Map<string, Uint8Array> cache to avoid re-fetching.

    lib/validation.ts:
      Client-side TypeScript validation helpers (type checks, input sanitization).
      Does NOT do math â€” that is the WASM engine's job.

    lib/wasm-health-check.ts:
      Runs 3 sanity tests against the WASM engine at startup:
        1+1 = 2?  2*3 = 6?  4/2 = 2?
      If any fail, displays a red warning banner in MathStage.


================================================================================
  SECTION 4: THE MATH ENGINE (Rust WASM â€” math-engine/)
================================================================================

  FILE: math-engine/src/lib.rs
  OUTPUT: static/wasm/math_validator_bg.wasm + math_validator.js

  This is the brain of the validation system. All math checking happens here.
  It is a PURE RUST LIBRARY compiled to WebAssembly.

  What it does:
    - Parses and evaluates math expressions using a hand-written evaluator.
    - Compares the student's answer to the expected answer.
    - Returns detailed feedback (is it correct? what's the hint?).

  Key exported functions (callable from JavaScript):
    validate_arithmetic(expression, expected_answer) â†’ bool
      Example: validate_arithmetic("2+2", 4) â†’ true

    validate_equation(expression, expected_answer) â†’ bool
      Substitutes a variable and checks both sides balance.

    validate_fraction(student_fraction, correct_fraction) â†’ bool
      Cross-multiplication comparison (no floating point drift).

    simplify_fraction(numerator, denominator) â†’ string
      Returns the lowest-terms representation as "N/D".

    check_answer(type, problem, student_answer) â†’ JSON string
      Master function â€” routes to the correct validator and returns:
      { correct: bool, hint: string, problem: string, answer: string }

    batch_validate(expressions[], answers[]) â†’ bool[]
      Validates multiple answers at once (for lesson completion checks).

  Why Rust (not JavaScript)?
    - Determinism. JavaScript floats can behave oddly (0.1 + 0.2 â‰  0.3).
    - Rust evaluates fractions using integer arithmetic â€” no rounding errors.
    - Performance. WASM runs at near-native speed.
    - Frozen Core principle â€” the math logic is sealed and tested separately.

  Purity Tests (math-engine/tests/purity_test.rs):
    22 property tests that each run 100 times.
    They verify the WASM functions are DETERMINISTIC:
      "validate_arithmetic('2+2', 4) must ALWAYS return true, never sometimes."
    This catches hidden state bugs (e.g., a random seed leaking in).

  How to compile:
    deno task build:wasm
    â†’ Output written to static/wasm/


================================================================================
  SECTION 5: THE CSS THEME (static/)
================================================================================

  The visual theme is a faithful Discord dark-mode recreation.
  The CSS is split into modular files:

  static/discord.css         â† Entry point. Imports all modules below.

  static/css/base.css        â† CSS variables (color palette, fonts, sizes).
                                The :root block. All other files use var(--...).
  static/css/layout.css      â† App shell, title bar, sidebar layout.
  static/css/components.css  â† Toggle buttons, error pages.
  static/css/modules/
    math-stage.css           â† Exercise cards, WASM badge, loading states.
    lesson.css               â† Lesson markdown, MDX prose styles, KaTeX math.
    lesson-toc.css           â† Right sidebar TOC, related topics.
    simulator.css            â† Volume simulator layout and sliders.

  Key Design Decisions:
    .app-shell { overflow: clip }
      Uses "clip" not "hidden". This prevents JavaScript's scrollIntoView()
      from accidentally scrolling the title bar off-screen.

    .title-bar { position: sticky; top: 0 }
      Keeps the title bar visible at all times, even if content is long.

    body.maximized .app-shell { padding: 8px }
      On Windows, maximizing a frameless window expands it 8px past the
      screen edge. This 8px padding compensates so nothing is clipped.


================================================================================
  SECTION 6: THE ANTI-LOGIC DRIFT SYSTEM
================================================================================

  "Logic Drift" is the silent killer of projects. It happens when code still
  compiles and tests pass, but the actual behavior has subtly changed.
  Sovereign Academy uses a "Defense in Depth" strategy with 7 distinct pillars.

  Full details in: docs/anti_logic_drift_principles.txt

  â”€â”€ PILLAR 1: LAWS OVER OPINIONS (Enforcement) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Rules that aren't machine-enforced don't exist.
    â€¢ scripts/verify-boundaries.ts: Prevents "spaghetti code" by blocking
      illegal imports between layers (e.g., UI islands cannot import Routes).
    â€¢ deno task check: Blocks the build if there are any type errors or lint
      violations. This is the "Zero-Tolerance" policy.

  â”€â”€ PILLAR 2: DETERMINISM (Pure Math Engine) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    The same input must ALWAYS produce the same bit-identical output.
    â€¢ math-engine/tests/purity_test.rs: Runs 21 math scenarios 100 times each.
      If a validator returns "true" for 2+2=4 once, but "false" the next time
      due to hidden state or floating-point drift, the project SCREAMS.
    â€¢ Deterministic Rust: Fractions are validated using integer cross-
      multiplication, bypassing JavaScript's unreliable floating-point math.

  â”€â”€ PILLAR 3: ZERO TRUST (Multiple Verification Layers) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    We don't trust the code, and we don't even trust the tests.
    â€¢ lib/wasm-health-check.ts: Even if the code passes unit tests, the APP
      itself verifies the WASM engine's health on Every. Single. Startup.
    â€¢ Double Verification: Many features are tested both by Rust unit tests
      and TypeScript Vitest unit tests to ensure no single-point-of-failure.

  â”€â”€ PILLAR 4: OBSERVABILITY (Golden Snapshots) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Silent failures are impossible because we snapshot the "perfect" state.
    â€¢ Layer 1 (Static): tests/golden/lib-contracts.txt (API signatures)
    â€¢ Layer 2 (State): tests/golden/state-flow.log (Logic sequences)
    â€¢ Layer 3 (UI): tests/golden/ui-*.html (HTML structure)
    â€¢ Layer 4 (Design): tests/golden/css-tokens.txt (Color/token variables)
    â€¢ Layer 5 (Engine): tests/golden/physics.txt (Math results)

    Any change to the code that alters one of these snapshots triggers a
    "DRIFT DETECTED" error in CI, forcing a conscious architectural review.

  â”€â”€ PILLAR 5: QUANTIFIED RISK (FMEA) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    We don't guess where bugs might be. We calculate it.
    â€¢ docs/file.todo & docs/anti_logic_drift_principles.txt:
      Critical systems (like the native shell and math engine) are identified
      as "Frozen Cores". They have the highest RPN (Risk Priority Number)
      and require the most verification steps to modify.

  â”€â”€ PILLAR 6: TIERED CRITICALITY (Frozen Core) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Not all code is equal.
    â€¢ desktop/src/main.rs (Shell) and math-engine/ (Logic) are protected.
    â€¢ They are "Frozen" â€” they rarely change, and when they do, they require
      running the full `deno task verify` suite multiple times.
    â€¢ UI styles and content are "Soft" â€” they can iterate quickly as long as
      they don't break the "Hard" logic below them.

  â”€â”€ PILLAR 7: TESTED RECOVERY (Git Bisect) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    If the system drifts, we find the culprit in minutes, not hours.
    â€¢ scripts/bisect-verify.ts: A specialized tool that automates the
      "Git Bisect" process.
    â€¢ If a bug is found today that wasn't there last week, you run:
      `git bisect run deno task bisect:verify`
      and the computer mathematically narrows down the exact line of code that
      caused the logic drift.


  â”€â”€ THE MASTER VERIFICATION GATE (deno task verify) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    This command runs EVERY guard in order. If one fails, the project is considered
    "Unstable" and cannot be pushed to production.

    1. deno lint / fmt / check  (Code Quality)
    2. verify-boundaries.ts      (Architecture Guard)
    3. cargo test                (Math Engine Unit + Purity Tests)
    4. vitest                    (TypeScript Unit Tests)
    5. snapshot verify           (Snapshot Drift Detection)

  Pre-push hook (.git/hooks/pre-push):
    Blocks `git push` if `deno task verify` fails. The code on GitHub is
    guaranteed to be bit-perfect and regression-free.


================================================================================
  SECTION 7: HOW DATA FLOWS â€” EXAMPLE WALKTHROUGH
================================================================================

  Scenario: Student selects "Fractions" topic and answers a math problem.

  Step 1 â€” Topic Selection
    â†’ User clicks "ğŸ¥§ Fractions" in Sidebar.tsx
    â†’ Sidebar calls selectTopic(6) from lib/state.ts
    â†’ The activeTopic signal changes to 6.

  Step 2 â€” Exercise Loading
    â†’ MathStage.tsx is subscribed to activeTopic. It re-renders.
    â†’ MathStage calls lib/exercise-loader.ts:
        loadExercise("/exercises/fractions/topic-6-001.bin")
    â†’ The loader fetches the .bin file (or uses the in-memory cache).
    â†’ The binary is parsed: type=fraction, problem="1/2 + ?= 3/4", answer="1/4"
    â†’ The currentExercise signal is updated.

  Step 3 â€” User Interaction
    â†’ MathStage renders the exercise card with the problem.
    â†’ Student types "1/4" in the input box.
    â†’ studentAnswer signal updates on every keystroke.

  Step 4 â€” Answer Validation
    â†’ Student clicks "Check Answer".
    â†’ MathStage calls the WASM engine:
        wasmModule.check_answer("fraction", "1/2 + ?= 3/4", "1/4")
    â†’ Rust evaluates: cross-multiplies, compares. Returns:
        { correct: true, hint: "Correct!", problem: "...", answer: "1/4" }
    â†’ lastResult signal is updated.

  Step 5 â€” Feedback + Advance
    â†’ MathStage shows the green "Correct! âœ“" result card.
    â†’ markCompleted(6) is called â†’ progress signal updates.
    â†’ 1.5 seconds later, MathStage auto-loads the next exercise.
    â†’ Sidebar re-renders because progress changed â†’ badge updates to show +1.


================================================================================
  SECTION 8: DEVELOPMENT COMMANDS REFERENCE
================================================================================

  Start development server (browser mode):
    deno task dev              â†’ http://localhost:5173

  Start full desktop app:
    deno task launch:desktop   â†’ Compiles Rust + starts server + opens window

  Run ALL verification (before pushing):
    deno task verify

  Run only unit tests:
    deno task test:unit        â†’ 70 TypeScript tests (Vitest)
    deno task test:rust        â†’ 31 Rust tests (cargo test)

  Update golden snapshots (after intentional changes):
    deno task snapshot:all

  Compile WASM math engine:
    deno task build:wasm

  Format code:
    deno fmt


================================================================================
  SECTION 9: THE FILE TREE (Where Is Everything?)
================================================================================

  Ihaveschool_deno/
  â”‚
  â”œâ”€â”€ desktop/               â† Rust native window shell (FROZEN CORE)
  â”‚   â””â”€â”€ src/main.rs        â† The frameless window â€” DO NOT TOUCH
  â”‚
  â”œâ”€â”€ math-engine/           â† Rust math validation (FROZEN CORE)
  â”‚   â”œâ”€â”€ src/lib.rs         â† WASM functions
  â”‚   â””â”€â”€ tests/purity_test.rs â† 22 purity/determinism tests
  â”‚
  â”œâ”€â”€ static/                â† Built assets served to browser
  â”‚   â”œâ”€â”€ discord.css        â† CSS manifest (imports modules below)
  â”‚   â”œâ”€â”€ css/               â† Modular CSS
  â”‚   â”‚   â”œâ”€â”€ base.css       â† Color variables
  â”‚   â”‚   â”œâ”€â”€ layout.css     â† Shell + sidebar + title bar
  â”‚   â”‚   â”œâ”€â”€ components.css â† Toggle buttons, error pages
  â”‚   â”‚   â””â”€â”€ modules/       â† Feature-specific CSS
  â”‚   â””â”€â”€ wasm/              â† Compiled .wasm + .js glue
  â”‚
  â”œâ”€â”€ routes/                â† Server-rendered pages (Fresh)
  â”‚   â”œâ”€â”€ _app.tsx           â† HTML shell template
  â”‚   â”œâ”€â”€ index.tsx          â† Main page layout
  â”‚   â”œâ”€â”€ lesson/[...slug].tsx â† MDX lesson page
  â”‚   â””â”€â”€ api/               â† REST API endpoints
  â”‚
  â”œâ”€â”€ islands/               â† Interactive Preact components
  â”‚   â”œâ”€â”€ TitleBar.tsx       â† Window controls + drag region
  â”‚   â”œâ”€â”€ Sidebar.tsx        â† Topic channel list
  â”‚   â”œâ”€â”€ MathStage.tsx      â† Main learning area
  â”‚   â”œâ”€â”€ LessonToc.tsx      â† Right TOC sidebar
  â”‚   â””â”€â”€ VolumeSimulator.tsx â† 3D geometry explorer
  â”‚
  â”œâ”€â”€ lib/                   â† Pure TypeScript utilities
  â”‚   â”œâ”€â”€ state.ts           â† Global signals (Preact Signals)
  â”‚   â”œâ”€â”€ exercise-loader.ts â† Binary .bin file parser + cache
  â”‚   â”œâ”€â”€ validation.ts      â† Input helpers
  â”‚   â””â”€â”€ wasm-health-check.ts â† Startup WASM verification
  â”‚
  â”œâ”€â”€ content/               â† MDX lesson files
  â”‚   â””â”€â”€ lesson-demo.mdx    â† Example KaTeX + markdown lesson
  â”‚
  â”œâ”€â”€ tests/
  â”‚   â”œâ”€â”€ golden/            â† Snapshot baselines (tracked in git)
  â”‚   â””â”€â”€ e2e/               â† Playwright end-to-end tests
  â”‚
  â”œâ”€â”€ scripts/               â† Maintenance and verification scripts
  â”‚   â”œâ”€â”€ snapshot-*.ts      â† Generate golden snapshot files
  â”‚   â”œâ”€â”€ verify-*.ts        â† Compare snapshots (drift detection)
  â”‚   â””â”€â”€ bisect-verify.ts   â† Git bisect helper
  â”‚
  â”œâ”€â”€ docs/                  â† Documentation
  â”‚   â”œâ”€â”€ project_overview.txt       â† THIS FILE
  â”‚   â””â”€â”€ anti_logic_drift_principles.txt â† Quality philosophy
  â”‚
  â”œâ”€â”€ skills/                â† AI agent instruction files
  â”‚   â”œâ”€â”€ sovereign-core/    â† Core dev patterns
  â”‚   â”œâ”€â”€ fresh-v2/          â† Fresh 2.x technical reference
  â”‚   â””â”€â”€ coding-standards/  â† 800 LOC rule + naming conventions
  â”‚
  â”œâ”€â”€ deno.json              â† Config + all task commands
  â”œâ”€â”€ GEMINI.md              â† AI agent context (project rules)
  â””â”€â”€ file.todo              â† Project roadmap (source of truth)


================================================================================
  END OF DOCUMENT
================================================================================
